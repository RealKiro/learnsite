/*jslint browser: true*/
/*global  $*/

$(function () {
    "use strict";
    //the table where the grid will be built
    const PIXELCANVAS = $("#pixel_canvas");
    const PALETTE = $("#palette"); //color selection table
    const BODY = $("body");
    let colorPicker = "rgb(0, 0, 0)";
	let oldcolor;
	
    // determine wether mouse is down or not
    let mouseDown = false;
	let mouseright=false;
	let mousegrid=true;
	let userid="pixel";
	let usercount="imgcount";
	let imgcount=0;
	let imgpos=1;
	let canvaswidth=50;
	let canvasheight=30;
	let countframe=1;
	let currentframe="#fm"+countframe;
	var framearray=new Array();
	let flagplay=true;	
		
	//setTimeout(capture,2000);

	function capture(){
		
		var gif = new GIF({
		  workers: 2,
		  quality: 10,
		  width:104,
		  height:64
		});
		
		var canvas1 = document.getElementById("fm1");
		gif.addFrame(canvas1, {delay: 1000});
				
		var canvas2 = document.getElementById("fm2");
		gif.addFrame(canvas2, {delay: 1000});
		// or a canvas element

		gif.on('finished', function(blob) {
			//window.open(URL.createObjectURL(blob));
			download(blobToFile(blob));
			console.log(blob);
		});
		gif.render();
		
	}
	
	function getimg(fm){
		html2canvas(document.querySelector("#"+fm)).then(function(canvas){
			canvas.id=fm;
			document.body.appendChild(canvas);
		})
	}
	
	function blobToFile(blob) {
		return new File([blob], 'test.gif', { type: 'image/gif' });
	}

	function download(downfile) {
		const tmpLink = document.createElement("a");
		const objectUrl = URL.createObjectURL(downfile);

		tmpLink.href = objectUrl;
		tmpLink.download = downfile.name;
		document.body.appendChild(tmpLink);
		tmpLink.click();

		document.body.removeChild(tmpLink);
		URL.revokeObjectURL(objectUrl);
	}		
			
	//将二进制字符串转换成Unicode字符串
	function binaryToStr(str){
		var result = [];
		var list = str.split(" ");
		for(var i=0;i<list.length;i++){
			 var item = list[i];
			 var asciiCode = parseInt(item,16);
			 var charValue = String.fromCharCode(asciiCode);
			 result.push(charValue);
		}
		return result.join("");
	}
	
	function uncompessframe(two)
	{	//开始解压工作
		//console.log(two);
		console.log("开始解压编码工作===================");
		console.log("二进制",Math.round(two.length/1024),"kb");
		var one =binaryToStr(two);//二进制字符串转字符
		console.log("LZString",Math.round(one.length/1024),"kb");
		var onede= LZString144.decompress(one);//lz解压为JSON字符串
		console.log("json编码",Math.round(onede.length/1024),"kb");
		let onearr=new Array();
		onearr= JSON.parse(onede);//JSON字符串转数组
		//console.log("数组",onearr);
		console.log("数组字节数",Math.round(onearr.toString().length/1024),"kb");
	
		var farr= onearr;
		//console.log("解码");
		//console.log(farr);
		let cf=1;
		framearray=new Array();
		farr.forEach(function(item){	
			let arr = item;
			let len=arr.length;
			let count=0;
			let tds="#pixel_canvas td";
			$(tds).each(function(){
				let cl=arr[count];
				if(cl==""){
					cl="0, 0, 0, 0";
				}			
				if(cl==" "){
					cl="0,0,0";
				}
				
				cl="rgba("+cl+")";
				$(this).css("background-color", cl);
				//console.log(cl);
				count++;
			})
			
			var img=PIXELCANVAS.html();
			var imgthumb=img.replaceAll("cell","cellthumb");
			imgthumb="<table>"+imgthumb+"</table>";
			if(cf>1){
				var framehtml=`<div id="fm${cf}" class="frame"></div>`;		
				$("#framelist").append(framehtml);	
			}
			let currentframe="#fm"+cf;
			framearray.push(currentframe);
			cf++;			
			$(currentframe).html(imgthumb);
		})
		countframe=framearray.length;
		console.log("动画帧数：共",countframe,"桢");
		thumbview();
	}
	
	
	$(document).ready(function(){
		makeGrid();

		if(pixfile!=""){
			uncompessframe(pixfile);
			console.log("加载像素动画完毕");				
		}
	});
	
	var animate=null;
	$("#playArt").on("click", function (e) {
		if(flagplay){
			console.log("动画开始");
			this.innerText="停止";
			let flen=framearray.length;
			console.log("动画帧数：共",flen,"帧");
			let index=0;
			animate = setInterval(function(){
				if(index<flen){
					$(".frame").css("opacity", "0.6");
					const framename=framearray[index];
					$(framename).css("opacity", "1");
					let fimg=$(framename).html();
					fimg=fimg.replaceAll("cellthumb","cell");
					PIXELCANVAS.html(fimg);
					index++;
					console.log("第",index,"帧",framename);
				}
				else {
					index=0;
				}
			},500);
			flagplay=false;
		}
		else{
			clearInterval(animate);
			console.log("动画结束");
			this.innerText="播放";
			flagplay=true;
		}		
	});
	
	$("#framelist").on("click", ".frame", function (e) {	
		if(!flagplay){
			clearInterval(animate);
			console.log("动画结束");
			$("#playArt").text("播放");
			flagplay=true;			
		}
		currentframe="#"+this.id;
		let fimg=$(currentframe).html();
		//console.log(fimg);
		fimg=fimg.replaceAll("cellthumb","cell");
		PIXELCANVAS.html(fimg);
		console.log("当前帧",currentframe);			
		$(".frame").css("opacity", "0.6");
		$(currentframe).css("opacity", "1");

    });	
	
	function thumbview()
	{
		$(currentframe).css("opacity", "1");
		currentframe=currentframe ;
		let thumb=$(currentframe).html();
		console.log("当前帧",currentframe);
		var imgthumb=thumb.replaceAll("cellthumb","cell");
		PIXELCANVAS.html(imgthumb);
	}
	
    function makeGrid() {		
        const ROW = canvasheight ;
        const COLUMN = canvaswidth;
        //remove old grid (if any)
        PIXELCANVAS.children().remove();
        //build grid
        let j;
        for (j = 0; j < ROW; j += 1) {
            PIXELCANVAS.append("<tr></tr>");
            const tr = $("tr");
            let i;
            for (i = 0; i < COLUMN; i += 1) {
				var id="r"+j+"c"+i
                tr.last().append("<td id='"+id+"' class='cell'></td>");
            }
        }
    }
	
	$('#pixel_canvas').bind('contextmenu', function() {
            return false;
    });	
	//var pixfile ="11011010110000 100010010100000 110100111001011 11101011110110 1001100100111 1101100110001001 111101011011001 1101011101100011 11101011101110 111111001000 1011110001001100 11010011100010 1100110010100010 1110101111001101 1010101010111010 110111110101001 1100011001011000 110110111100111 1101110101100011 1110111010111101 1111001111111110 111100000001011 1110100000100100 111000010110001 100001000100110 1000110010011110 10101001101100 1001100111110011 1010011000101011 1001010010100001 111001010110101 1010101000110100 1010101011011110 1011101101100110 1001110111111010 1111011000011101 1101110001100000 1100100110100011 1010011000101111 1001101010110110 110011011100101 1101101111010110 1110111000111000 111110011111110 1110101110100111 110111001011111 1011101011111001 1110011111000111 1011111111011110 1110100000000000 1001100000000001 101100000000001 1100000100000 1001 1000000000 101100100000011 10001110000011 1010001101100001 1100000010 110011001 10001101000011 100001011010010 10001001010010 111000 1001001101010011 1101001100110011 10001101110011 1111001010110010 11001010110010 100101010100001 1001001011001010 1000101110110010 1111001010101010 101000100011 1100101110001011 1110101101000001 1010101100001010 10101101011011 1101101010011011 110101100101010 1101101100011011 1001101011101011 100101000111010 101101110000110 111101100111010 1001001011000011 10001001100010 1110001000100010 1001101111100 1100011100 100001111000010 1010001101100011 1110001100010011 1001000010100110 1110011000000001 1101100110100110 11000 100111001 110000010110111 1000001101110110 1010001100001111 110000001010010 1100101000001110 1011001100000011 100001100101111 1010111101101111 1110111010101011 100001110000011 1101001000000110 111001000000000 1101100010010011 101111111011110 1100101010111111 110000010100001 1110101100 1100100000011110 1001000000111011 10100000001 1100000010110000 101100000100010 1110010000110 101101101001100 1101011001110011 110110100010 1100000101101110 110011110000110 1010110101100110 1111001101001101 1000101011010100 1110111110110010 11100101000000 100111001100111 100000010000101 1100101000000101 111001100000101 11110000011110 1110010011101001 1011001111001101 1010101111110010 110100001111101 1011111000101111 11011110111101 11111111101000 1100110100000001 1001000001 11100011000 110010000110011 1001110111001011 1000010101101100 110011011101011 101010001111111 1000000111001110 1000110000010101 10001011010000 1000010010111100 111000111000111 1010001001001 10011010000000 1100100101001101 1101110110101 11001010010100 1010100010100101 11001011111110 1110100100000000 100011010100101 1001010110101011 110010001110011 1010000101001010 1101100001111011 10101000010100 1010101111100101 1100000011000101 1000100010101100 100101000100100 101001001100100 1011011001100011 1001000111111000 111101101010000 1010101010100000 10101010110111 10001110011101 1001011010111 100101011011100 101110101101010 111010110111010 1110111000010 1001101101111110 1001001111010111 1110111111100100 1111101111011101 1011000000011100 1011101111011010 10110100110001 100100011010011 1010001111110100 1101100011010100 101111000110101 1100110001101 1100011000010011 1110100110010100 1100110100110100 11100011101111 110000100011 1110110110 1110000011011110 1001011100110110 1000010100101100 1011110011001110 11100100110011 1000000111011111 1101101001100 1010111101010111 110101101110111 111101011100100 100011010110011 1111011001101100 100010101011011 1010111001000 1001010101100101 1011100011011101 101110110111 11101101101101 11001011 1010001011011100 11101011110111 1011010001011 1010101001110010 1101000011100010 11100001011111 110011100000101 110111010000001 10111001000100 100011100100111 1011010000000100 10111110100110 100101111101110 1101101011101010 101011110100 101111100101111 101011111101011 1111110111110110 1110100011111001 1011100000111100 1110111111100111 1100011110010101 1100010111101111 111011001111001 11111011101110 11011101010001 10110111110101 1111001001101011 11100100011111 100111010000011 1001111110100101 11010011101110 1110110011001101 100000110010 111111000111111 1100000000001001 1101010111111111 101011001010000 110011010100 1001101001101101 101011010010010 1011000000 1001000000111000 111010000010 10000011010000 1000101000001101 1111110100010000 1110010000101110 1001010100000010 1111010101110000 11011101010100 1000001011011001 111111010010 111011111000010 100010000011111 1101110100001111 1000001001010000 1110110000101001 110111000011 1000100011011000 10000100001011 10001011010000 1001100000110011 101110000010 1010100011010010 10001100001001 1100001010110000 1110011000111100 1000110101100010 100100011001010 11111010001110 1010001011011000 1101101000110101 110111000010 1100011101101011 100111100001000 1001110001000100 1011001011010000 100100011110101 1100010011010111 1100000010110111 111110100100100 1110111101011010 100111100011100 111111101011001 10011001110111 1001001010000100 1010010100110001 100101101111100 1010010110101 10101101001000 1101001101010100 1001110100100010 100101111010010 1011111101010001 10011100000111 101001001010100 1111110100110100 1100101010010010 11000100011001 10000011001011 1001001100101100 1100110100111010 1100111001010011 110110011011101 11110011001001 1011001101111101 11001100110001 1100101101110011 101110010001011 11001111001001 111001100100011 1111100101110 111000100110011 1101110010101111 11011111001010 11001110000011 10111011 1100100001110011 1100001010110000 1011100000101010 1000101111111100 1110110100111001 1100100010001011 1010001010111000 1011000000101011 1111001010101100 1111100010100110 10110101001011 1001001010000100 1011011000101111 1011001110000100 1100001100110011 1100011101001010 1110110010110100 1010100100101100 1000101110001010 1100010010100111 10110100101011 1011001010100010 1011110010101110 1010101010101010 1101101010110011 10100000101010 1001110011111010 1010001010101000 1100101111000010 1011110010101110 1101000000011001 111101000101110 1000001110101000 1001100000011010 1101010000111 1010111111101000 1111101011010001 1001011110101001 1100010000110 110000110111100 110001000011010 11010010001 1010111110100110 1110100100000110 110100110111011 1010100010011010 110011011001110 1010110001100101 1001101010111010 1100000110110100 110110010011011 1100011011110101 1011000101101111 1110101110110110 1000010110111110 110101011011011 1111011010111001 1010110101101010 11101010100110 1101010110110100 1110111001011010 1001011010110001 1010010101101000 1011101001110110 1100001110101100 1110110011011010 100111010000111 1011111011101110 1011101001010100 10111 100001000000011 11011010 1001000010101011 1110100111111010 100011011111 1011101111101011 1111101100000001 1000000001111000 1111111111011 100000110100000 110110000011001 11111000001 1010100001110010 1100110000110 10000110111000 111101000011111 1000011101100001 1000010001111001 1101001000111 101000111000100 111110100011001 100011000110001 1011010001110011 1100111000111 1011000110111100 110101100011000 10011101110001 1100001001111111 1101000100111 100100110010010 111110010011110 10011100101001 1011001001101010 1001100010100111 1010100110110010 110000110101000 1111001011001010 1111100010100110 1001100110100111 1010011101000100 1101111111110110 100110101010010 100110011001001 11000011001100 1101001100011110 111101100110011 1110011000111001 1101111001100101 10111100011100 101100111111010 110110101001111 1110110110111011 11011001101 1011001010010111 111101100011001 110010101110110 1001011010111011 10101101110 101101001010110 111101100001110 1100111110110000 1110100011011 10010100101100 101111000000111 1010011101011011 1100100111110111 11110101001111 1101111110 1111010010111100 1110111100010111 1100000111110010 1011110100001111 101101101100 1101101010110111 100110111100011 111110011011011 1011011110010010 100001101111010 1101111110110111 110110111011100 1010111010011001 101010001000 1011101000100101 1000100001100011 1011100010100110 11001110001110 1111011111011000 1101111101100111 1101100111100010 1111111110 10001110001100 110001010111000 1001000011111111 1101110001100011 1011010110001111 111000011001010 1111011111000011 1110000011101000 11110100001111 10001111000000 1110111110001001 1010001000101000 1111010011101011 11101001001111 101001110111111 110101000111001 100111001100011 1111110011111011 11100010001110 1111110111100110 1011010001011111 1000111011011100 11001101000 10110010101010 1001101010011010 1010111010111011 1010101001001010 1111101011101001 1011110001101110 1001100110000110 1111110110111001 110111100110010 1001110101100100 1011011100101111 1101011001110 1111111110111011 110111000000111 1101101011101000 111100101101011 11110110001 1111100001111111 1111101000111 1000100111111010 111101010011110 100011101101110 1111001001000110 1010111001000101 1011111011110010 111110000101010 11101110010101 1111100101111001 1001111101010111 1001000111101011 111111101011111 1100111001101 1110001101111101 1001111001110111 1111110111101111 11010110100111 1011100001000101 1110101100101100 11111000001111 1010001111110010 1111101111011110 110111110011010 1110111011111010 101111101101111 1110101111111001 1111101010111111 101111110100111 1110110111111111 1011111001011111 1111011111100100 1111111110011110 10110100111011 1010011011101011 1101101011000111 101100111101010 101110100001101 1010001011110101 100000001001000 110111011010 11101001000 10000000000 1010100000011110 111010010101110 1000010000001111 1111111011110000 11011011101011 100000010100100 1100000000010 1110000001111000 111001000001 1110100000110010 11000111101 11000000011101 1000001110000000 110011000001010 111101000110000 10011100000100 10000010010100 1000110000010 10011010111100 1000010101111010 1010111101001000 0";
    
});
