<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äººå·¥æ™ºèƒ½ - è¯­éŸ³åˆæˆæŠ€æœ¯</title>
    <link rel="stylesheet" href="deepseek.css">
	
</head>
<body>
    <div class="container">		
        <div class="left-column">		
			<!-- èŠå¤©åŒºåŸŸ -->
			<div class="chat-container" id="chatHistory">
				<!-- èŠå¤©è®°å½•å°†åŠ¨æ€åŠ è½½åˆ°è¿™é‡ŒğŸ³  -->
				<div class="wall">
				<h2><img  src="speek.png" /> äººå·¥æ™ºèƒ½ - è¯­éŸ³åˆæˆï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼
				</h2>
				</div>
			</div>
			
			<!-- è¾“å…¥æ¡†åŒºåŸŸ -->
			<div class="loading-container">
			<!-- åŠ è½½çŠ¶æ€ -->
			<div id="loading" style="display: none;"><img src="loading.gif" />è¯­éŸ³åˆæˆä¸­...</div>
			
			</div>

			<!-- è¾“å…¥æ¡†åŒºåŸŸ -->
			<div class="input-container">
				<textarea id="userInput" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." rows="3"  maxlength="1000" ></textarea>
				<div>
				<button id="btnmsg" onclick="sendText()" title="åˆæˆè¯­éŸ³">åˆæˆè¯­éŸ³</button>
				<div style="margin-top:10px;">
				<select id="voiceSelect" title="é€‰æ‹©å‘éŸ³äºº">
					<option value="zh-CN-XiaoxiaoNeural">æ™“æ™“ æ¸©æš– å¥³</option>
					<option value="zh-CN-XiaoyiNeural">å°è‰º æ´»æ³¼ å¥³</option>
					<option value="zh-CN-YunjianNeural">äº‘å¥ ç¨³é‡ ç”·</option>
					<option value="zh-CN-YunxiNeural">äº‘æºª é˜³å…‰ ç”·</option>
					<option value="zh-CN-YunxiaNeural">äº‘å¤ å¯çˆ± ç”·</option>
					<option value="zh-CN-YunyangNeural">äº‘é˜³ ä¸“ä¸š ç”·</option>
					<option value="zh-CN-liaoning-XiaobeiNeural">è¾½å® å°åŒ— å¥³</option>
					<option value="zh-CN-shaanxi-XiaoniNeural">é™•è¥¿ å°å¦® å¥³</option>
					<option value="zh-HK-HiuGaaiNeural">é¦™æ¸¯ æ™“ä½³ å¥³</option>
					<option value="zh-HK-HiuMaanNeural">é¦™æ¸¯ æ™“æ–‡ å¥³</option>
					<option value="zh-HK-WanLungNeural">é¦™æ¸¯ ä¸‡é¾™ ç”·</option>
					<option value="zh-TW-HsiaoChenNeural">å°æ¹¾ æ™“æ™¨ å¥³</option>
					<option value="zh-TW-HsiaoYuNeural">å°æ¹¾ æ™“é›¨ å¥³</option>
					<option value="zh-TW-YunJheNeural">å°æ¹¾ äº‘å“² ç”·</option>
				</select>
				</div>
				</div>
				
			</div>
        </div>	
		
        <div class="right-column">
			<!-- å¯¼èˆªæ  -->
			<div class="navbar">
			<img src="speek.png" /> å†å²å¯¹è¯è®°å½•
			</div>
			<!-- èŠå¤©è®°å½•æ  -->
			<div id ="chatbar">			
			</div>
        </div>

 </div>
    <script>
        let messageHistory = []; // æ–°å¢ï¼šå­˜å‚¨å¯¹è¯å†å²çš„æ•°ç»„
		
		var port=":2000";//ç«¯å£
		var lor=location.origin+port;// http://192.168.1.3
		console.log(location.origin);
		
        const apiChatUrl = lor+"/voice";
			
		const userTextarea = document.getElementById("userInput");
		const userchatbar = document.getElementById("chatbar");
        const sendButtonmsg = document.getElementById("btnmsg");
		const selectElement = document.getElementById("voiceSelect");

        async function sendText() {
            const userInput = userTextarea.value;
            const selectedValue = selectElement.value;
            if (!userInput) return;
			
            sendButtonmsg.disabled = true;
			userTextarea.disabled = true;

            // æ–°å¢ï¼šå°†ç”¨æˆ·æ¶ˆæ¯æ·»åŠ åˆ°å†å²è®°å½•
			const userMessage = { role: selectedValue, content: userInput };
            addMessage("user", userInput);

            try {
                document.getElementById("loading").style.display = "block";
                const response = await fetch(apiChatUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ messages: userMessage }) 
                });
                
                const data = await response.json();
                
                // æ–°å¢ï¼šå°†AIå›å¤æ·»åŠ åˆ°å†å²è®°å½•
                const botMessage = { role: "assistant", content: data.response };
                addMessage("bot", data.response);
			
				const chatTitle = document.createElement("div");
				chatTitle.className="chattitle";
				chatTitle.innerHTML=userInput;
				userchatbar.appendChild(chatTitle);
			
            } catch (error) {
                console.error("Error:", error);
                const errorMessage = { role: "assistant", content: `Error: ${error.message}` };
                addMessage("sys", `Error: ${error.message}`);
            } finally {
                document.getElementById("loading").style.display = "none";
                sendButtonmsg.disabled = false;
				userTextarea.disabled = false;
                document.getElementById("userInput").value = "";
            }
        }
		
		
		function addMessage(role, content) {
			const chatHistory = document.getElementById("chatHistory");
			const messageDiv = document.createElement("div");
			messageDiv.className = `message ${role}`;
			if (role === "bot") {
				pauseAllAudio();//æš‚åœæ‰€æœ‰
				messageDiv.innerHTML = ` <audio src="${content}" autoplay controls ></audio> <img class="download" src="down.gif" onclick="download('${content}')" title="ç‚¹å‡»ä¸‹è½½éŸ³ä¹" />`;
			}else {
				messageDiv.innerHTML = `<div class="user">ğŸ“ ${content}</div>`;
			}
			chatHistory.appendChild(messageDiv);

			// æ»šåŠ¨åˆ°åº•éƒ¨
			chatHistory.scrollTop = chatHistory.scrollHeight;
			userTextarea.style.height = "auto";
		}

        // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
        document.getElementById("userInput").addEventListener("input", (event) => {
            event.target.style.height = "auto";
            event.target.style.height = event.target.scrollHeight + "px";
        });
		
		function pauseAllAudio() {
			// è·å–é¡µé¢ä¸­çš„æ‰€æœ‰éŸ³é¢‘å…ƒç´ 
			const audioElements = document.getElementsByTagName('audio');
			
			// éå†æ¯ä¸ªéŸ³é¢‘å…ƒç´ ï¼Œè°ƒç”¨ pause æ–¹æ³•
			for (let audio of audioElements) {
				audio.pause(); // æš‚åœå½“å‰éŸ³é¢‘
			}
		}
		
		function download(url) {
			fetch(url)
				.then(response => response.blob())
				.then(blob => {
					const link = document.createElement('a');
					link.href = URL.createObjectURL(blob);
					var lastOf = url.lastIndexOf('/');
					var filename = url.substr(lastOf + 1); 
					link.download = filename;
					link.click();
				});
		}
    </script>
</body>
</html>