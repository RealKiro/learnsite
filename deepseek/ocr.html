<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äººå·¥æ™ºèƒ½ - æ–‡å­—è¯†åˆ«æŠ€æœ¯</title>
    <link rel="stylesheet" href="deepseek.css">
	
</head>
<body>
    <div class="container">		
        <div class="left-column">		
			<!-- èŠå¤©åŒºåŸŸ -->
			<div class="chat-container" id="chatHistory">
				<!-- èŠå¤©è®°å½•å°†åŠ¨æ€åŠ è½½åˆ°è¿™é‡ŒğŸ³  -->
				<div class="wall">
				<h2><img  src="ocr.png" /> äººå·¥æ™ºèƒ½ - æ–‡å­—è¯†åˆ«ï¼Œå¾ˆé«˜å…´çœ‹è§ä½ ï¼
				</h2>
				</div>
			</div>
			
			<!-- è¾“å…¥æ¡†åŒºåŸŸ -->
			<div class="loading-container">
			<!-- åŠ è½½çŠ¶æ€ -->
			<div id="loading" style="display: none;"><img src="loading.gif" />æ–‡å­—è¯†åˆ«ä¸­...</div>
			
			</div>

			<!-- è¾“å…¥æ¡†åŒºåŸŸ -->
			<div class="input-container">
				<div class="other">
					<input type="file" name="file" id="userfile" accept="image/*" hidden>
					<button id="uploadbtn" >ä¸Šä¼ å›¾ç‰‡</button>
					<button id="btnmsg" onclick="sendText()" title="æ–‡å­—è¯†åˆ«">æ–‡å­—è¯†åˆ«</button>
				</div>
				
			</div>
        </div>	
		
        <div class="right-column">
			<!-- å¯¼èˆªæ  -->
			<div class="navbar">
			<img src="ocr.png" /> å†å²å¯¹è¯è®°å½•
			</div>
			<!-- èŠå¤©è®°å½•æ  -->
			<div id ="chatbar">			
			</div>
        </div>

 </div>
    <script>
        let messageHistory = []; // æ–°å¢ï¼šå­˜å‚¨å¯¹è¯å†å²çš„æ•°ç»„
		
		var port=":2000";//ç«¯å£
		var lor =location.origin + port;// http://192.168.1.3
		console.log(lor);
		
        const apiUploadUrl = lor+"/upload";
        const apiChatUrl = lor+"/ocr";
			
		const userfile = document.getElementById("userfile");
		const uploadbtn = document.getElementById("uploadbtn");
		const userchatbar = document.getElementById("chatbar");
        const sendButtonmsg = document.getElementById("btnmsg");
		let imgfilename ;
        sendButtonmsg.disabled = true;
		
		//console.log(userform.action);
		// ä¸ºè¡¨å•æ·»åŠ æäº¤äº‹ä»¶ç›‘å¬å™¨
        userfile.addEventListener('change', async (event) => {
			  const files = event.target.files;
			  if (!files) return;

			  // åˆ›å»ºå›¾ç‰‡å¯¹è±¡					
				//console.log("ä¸Šä¼ æ–‡ä»¶æ˜¯",files[0]);
				var formData = new FormData(); // åˆ›å»ºFormDataå¯¹è±¡
				formData.append("file",files[0]);
				// ä½¿ç”¨Fetch APIå‘é€POSTè¯·æ±‚
				fetch(apiUploadUrl, {
					method: 'POST',
					body: formData
				})
				.then(response => response.json()) // å°†å“åº”è§£æä¸ºJSON
				.then(data => {
					// åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºæœåŠ¡å™¨å“åº”
					var result =  JSON.parse(JSON.stringify(data));
					imgfilename = result["response"];
					console.log(imgfilename);
					addMessage("upload", imgfilename);				
					sendButtonmsg.disabled = false;
				})
				.catch(error => {
					console.error('Error:', error); // åœ¨æ§åˆ¶å°æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
				});
        });
		
		uploadbtn.addEventListener('click', function() {
			userfile.click();
		});

        async function sendText() {
            const userInput = imgfilename;
            if (!userInput) return;
			
            sendButtonmsg.disabled = true;
			uploadbtn.disabled = true;

            // æ–°å¢ï¼šå°†ç”¨æˆ·æ¶ˆæ¯æ·»åŠ åˆ°å†å²è®°å½•
			const userMessage = { role: "upload", content: userInput };

            try {
                document.getElementById("loading").style.display = "block";
                const response = await fetch(apiChatUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ messages: userMessage }) 
                });
                
                const data = await response.json();
                
                // æ–°å¢ï¼šå°†AIå›å¤æ·»åŠ åˆ°å†å²è®°å½•
                const botMessage = { role: "assistant", content: data.response };
                addMessage("bot", data.response);
			
				const chatTitle = document.createElement("div");
				chatTitle.className="chattitle";
				chatTitle.innerHTML=data.response;
				userchatbar.appendChild(chatTitle);
			
            } catch (error) {
                console.error("Error:", error);
                const errorMessage = { role: "assistant", content: `Error: ${error.message}` };
                addMessage("sys", `Error: ${error.message}`);
            } finally {
                document.getElementById("loading").style.display = "none";				
				uploadbtn.disabled  = false;
				imgfilename ="";
            }
        }
		
		
		function addMessage(role, content) {
			const chatHistory = document.getElementById("chatHistory");
			const messageDiv = document.createElement("div");
			messageDiv.className = `message ${role}`;
			if (role === "upload") {				
				messageDiv.innerHTML = `<img src="../deepseek/uploads/${content}" />`;
			}else {
				messageDiv.innerHTML = `<div class="user">${content}</div>`;
			}
			chatHistory.appendChild(messageDiv);

			// æ»šåŠ¨åˆ°åº•éƒ¨
			chatHistory.scrollTop = chatHistory.scrollHeight;
		}

			

    </script>
</body>
</html>